<?xml version="1.0" encoding="UTF-8"?><Node>
  <Permissions>
  </Permissions>
  <Doc lang="pt-PT">
  </Doc>
  <Libraries>
     <Use name="DateTimeLib" type="lib"/>
     <Use name="UtilsLib" type="lib"/>     
  </Libraries>
  <Configuration />
  <Screens>
  </Screens>
  <Actions>
  </Actions>
  <Library forceinterface="true">
    <Function name="getIdByCode" doc="Get a record id by its code from entity fw_agreement_schema">
      <Params>
        <Param name="code" type="string" required="true"/>
      </Params>
      <Return type="int" doc="">
		  </Return>
      <Begin>
        <Var name="record">
          <DataAccess method="load">
            <Param name="_entity">fw_agreement_schema</Param>
            <Param name="code"><Var name="PARAMS" key="code"/></Param>
          </DataAccess>
        </Var>
        <Return>
          <Var name="record" key="id"/>
        </Return>
      </Begin>
    </Function>
    
    <Function scope="public" name="addStatementByCode" doc="Adds a statement to a schema giving the several codes">
		<Params>
			<Param name="schema_code" type="string" doc="The schema code"/>
			<Param name="statement_code" type="string" doc="The statement code"/>
			<Param name="order" type="int" doc="The statement order in the schema"/>
			<Param name="start_date" type="int" doc="The statement start_date in the schema"/>
			<Param name="end_date" type="int" doc="The statement end_date in the schema"/>
		</Params>
		<Return type="int"/>
		<Begin>
			<Var name="schema">
				<DataAccess method="load" dump="true">
					<Param name="_entity">fw_agreement_schema</Param>
					<Param name="code"><Var name="PARAMS" key="schema_code"/></Param>
				</DataAccess>
			</Var>
			<Exception name="framework/agreement.schema::invalidCode" condition="$schema->__length == 0">
				<Param><Var name="PARAMS" key="schema_code"/></Param>
			</Exception>
	
			<Var name="statement">
				<DataAccess method="load">
					<Param name="_entity">fw_agreement_statement</Param>
					<Param name="code"><Var name="PARAMS" key="statement_code"/></Param>
				</DataAccess>
			</Var>
			<Exception name="framework/agreement.statement::invalidCode" condition="$statement->__length == 0">
				<Param><Var name="PARAMS" key="statement_code"/></Param>
			</Exception>
			<Var name="id">
				<DataAccess method="insert">
					<Param name="_entity">fw_agreement_schema_statement</Param>
					<Param name="id_agreement_schema"><Var name="schema" key="id"/></Param>
					<Param name="id_agreement_statement"><Var name="statement" key="id"/></Param>
					<Param name="order"><Var name="PARAMS" key="order"/></Param>
					<Param name="start_date"><Var name="PARAMS" key="start_date"/></Param>
					<Param name="end_date"><Var name="PARAMS" key="end_date"/></Param>
					<Param name="_base">true</Param>
				</DataAccess>
			</Var>
			<Return><Var name="id"/></Return>		
		</Begin>
	</Function>

    <Function scope="public" name="updateStatementByCode" doc="Updates a statement data in the schema giving the several codes">
		<Params>
			<Param name="schema_code" type="string" doc="The schema code"/>
			<Param name="statement_code" type="string" doc="The statement code"/>
			<Param name="order" type="int" doc="The statement order in the schema"/>
			<Param name="start_date" type="int" doc="The statement start_date in the schema"/>
			<Param name="end_date" type="int" doc="The statement end_date in the schema"/>
		</Params>
		<Return type="int"/>
		<Begin>
		<Var name="PARAMS" dump="true"/>
			<Var name="schema">
				<DataAccess method="load">
					<Param name="_entity">fw_agreement_schema</Param>
					<Param name="code"><Var name="PARAMS" key="schema_code"/></Param>
				</DataAccess>
			</Var>
			<Exception name="framework/agreement.schema::invalidCode" condition="$schema->__length == 0">
				<Param><Var name="PARAMS" key="schema_code"/></Param>
			</Exception>
	
			<Var name="statement">
				<DataAccess method="load">
					<Param name="_entity">fw_agreement_statement</Param>
					<Param name="code"><Var name="PARAMS" key="statement_code"/></Param>
				</DataAccess>
			</Var>
			<Exception name="framework/agreement.statement::invalidCode" condition="$statement->__length == 0">
				<Param><Var name="PARAMS" key="schema_code"/></Param>
			</Exception>
			<Var name="PARAMS" key="end_date" dump="true"/>
			<Var name="id">
				<DataAccess method="update">
					<Param name="_entity">fw_agreement_schema_statement</Param>
					<Param name="id_agreement_schema" pk="true"><Var name="schema" key="id"/></Param>
					<Param name="id_agreement_statement" pk="true"><Var name="statement" key="id"/></Param>
					<Param name="order"><Var name="PARAMS" key="order"/></Param>
					<Param name="start_date">
						<If condition="$PARAMS->start_date == ''">
							<Then>
								<Null/>
							</Then>
							<Else>
								<Var name="PARAMS" key="start_date"/>
							</Else>
						</If>
					</Param>
					<Param name="end_date">
						<If condition="$PARAMS->end_date == ''">
							<Then>
								<Null/>
							</Then>
							<Else>
								<Var name="PARAMS" key="end_date"/>
							</Else>
						</If>
					</Param>
					<Param name="_base">true</Param>
				</DataAccess>
			</Var>
			<Return><Var name="id"/></Return>		
		</Begin>
	</Function>	
	
	<Function scope="public" name="getFields" doc="Get all fields given a schema code. These fields will build the form">
	<Params>
		<Param name="code" type="string" doc="The schema code"/>
		<Param name="startDate" type="int" doc="Only get the fields that are active at this date"/>
	</Params>
	<Return type="multiple"/>
	<Begin>
		<!-- Validate the schema -->
		<!--Var name="schema">
			<DataAccess method="load">
				<Param name="_entity">fw_agreement_schema</Param>
				<Param name="code"><Var name="PARAMS" key="code"/></Param>
			</DataAccess>
		</Var>
		<Exception name="framework/agreement.schema::invalidCode" condition="$schema->__length == 0">
			<Param><Var name="PARAMS" key="code"/></Param>
		</Exception-->
		<Var name="codes"><ListToSet><Var name="PARAMS" key="code"/></ListToSet></Var>
		<Var name="fields" dump="true">
			<DataAccess method="this,this,schema.getFields">
				<!--Param name="id_agreement_schema"><Var name="schema" key="id"/></Param-->
				<Param name="schema_code_list"><Var name="codes"/></Param>
				<Param name="start_date"><Var name="PARAMS" key="startDate"/></Param>
				<Param name="_lang"><Var name="USER" key="lang"/></Param>
			</DataAccess>
		</Var>
		<Return><Var name="fields"/></Return>
	</Begin>
	</Function>	
  
  </Library>
</Node>