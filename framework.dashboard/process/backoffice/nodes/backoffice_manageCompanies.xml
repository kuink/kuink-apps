<?xml version="1.0" encoding="UTF-8"?>
<Node>
  <Doc>
    <Description>Framework Dashboard [Backoffice]  >  Companies Management  ::  Allows to view, edit and delete a company's details and their configurations.</Description>
  </Doc>
  <Permissions/>
  <Configuration/>
  <Libraries/>
  <Params/>
  
  
  
  
  
	<!-- __________________________________________________________________________________________________________________________
		*
		*
		*	      S C R E E N S    ::    mainScreen  |  configurationsScreen
		*
		*	 __________________________________________________________________________________________________________________________
	-->
  <Screens>
		<!--
			*
			*    mainScreen  |  Main page of Companies Management. Shows a list of companies, allowing to edit their details.
			*
		-->
    <Screen name="mainScreen" title="companies">
      <Menu name="back" label="back" icon="arrow-left" action="back"/>
      
      <!-- Companies -->
      <Grid name="companiesGrid" title=" " freeze="false">
        <Template>
          <Columns>
            <Column name="id" headeralign="center" verticalalign="middle" horizontalalign="center"/>
            <Column name="uuid" headeralign="center" verticalalign="middle" horizontalalign="center"/>
            <Column name="name" type="text" headeralign="center" verticalalign="middle" colsize="2" required="true"/>
            <Column name="code" type="text" headeralign="center" verticalalign="middle" required="true"/>
            <Column name="description" type="text" headeralign="center" verticalalign="middle" colsize="2"/>
            <Column name="location" type="text" headeralign="center" verticalalign="middle" colsize="2"/>
            <Column name="id_timezone" type="select" headeralign="center" verticalalign="middle" label="timezone" datasource="table:fw_timezone" bindid="id" bindvalue="code"/>
            <Column name="is_active" type="checkbox" headeralign="center" verticalalign="middle" horizontalalign="center"/>
            <Column name="id_company" type="select" headeralign="center" verticalalign="middle" datasource="table:fw_company" bindid="id" bindvalue="name"/>
          </Columns>
          <Actions separator="true" headeralign="center" verticalalign="middle">
            <Action name="companyConfigs" label="configs" icon="cog" actionvalue="id" condition="$id != '' || $id == '0'"/>
            <Action name="deleteCompany" label="delete" icon="trash-o" actionvalue="id" confirm="true" condition="$id != '' || $id == '0'"/>
          </Actions>
        </Template>
        <Actions>
          <Action name="saveCompanies" label="save" type="save"/>
        </Actions>
      </Grid>
    </Screen>

    
    <!--
			*
			*		configurationsScreen  |  Allows to view/edit a company's configurations.
			* 
		-->    
    <Screen name="configurationsScreen" title="configs">
      <Menu name="back" label="back" icon="arrow-left" action="init"/>
      
      <!-- Configurations -->
      <Grid name="configsGrid" freeze="false" title=" ">
        <Template>
          <Columns>
            <Column name="id" verticalalign="middle"/>
            <Column name="code" type="text" verticalalign="middle" colsize="2" required="true"/>
            <Column name="value" type="text" verticalalign="middle" colsize="4" required="true"/>
            <Column name="comment" type="text" verticalalign="middle"/>
          </Columns>
          <Actions separator="true" verticalalign="middle">
            <Action name="editConfig" actionvalue="id" label="edit" icon="edit" condition="$id != '' || $id == '0'"/>
            <Action name="deleteConfig" actionvalue="id" label="delete" icon="trash-o" confirm="true" condition="$id != '' || $id == '0'"/>
          </Actions>
        </Template>
        <Actions>
          <Action name="saveAllConfigs" label="save" type="save"/>
        </Actions>
      </Grid>
    </Screen>
    
    
    <!--
			*
			*    detailsScreen  |  Allows to edit the details of a company's configuration.
			*
		-->
		<Screen name="detailsScreen" title="details">
			<Menu name="back" icon="arrow-left" label="back" action="viewConfigurations"/>
			
			<!-- Details -->
			<Form name="detailsForm">
				<Static name="id" required="true" post="true"/>
				<Text name="code" required="true"/>
				<TextArea name="value" required="true"/>
				<TextArea name="comment" label="description" help="false"/>
				
				<ButtonGroup>
					<Button name="save" type="save" action="saveConfig"/>
				</ButtonGroup>
			</Form>
		</Screen>
  </Screens>

  


  <!-- __________________________________________________________________________________________________________________________
    *
    *
    *		    A C T I O N S    ::    
    *
		*	 __________________________________________________________________________________________________________________________
  -->
  <Actions>
    <!--
			*
			*    init  |  Configuration of 'mainScreen', to view/edit the details of all the companies.
			*
		-->
    <Action name="init" screen="mainScreen">
			<Permissions>
				<Allow>
					<Role name="system.admin"/>
				</Allow>
			</Permissions>
      
      <!-- Clears the current company -->
      <Var name="selectedCompanyId" process="true" clear="true"/>
      
      <!-- Gets all the companies and a blank row at the end, to add a new one, if wanted -->
      <Var name="companies"><Call library="framework,company,api" function="getAll"/></Var>
      <Var name="companies" key=""><Null/></Var>
      <Control method="bind" object="companiesGrid">
        <Param><Var name="companies"/></Param>
      </Control>
    </Action>
    
    
    <!--
			*
			*    companyConfigs  |  Changes the current company to the selected one, to edit its configurations.
			*
		-->
    <Action name="companyConfigs">
      <!-- Updates the current company -->
      <Var name="selectedCompanyId" process="true"><ActionValue/></Var>
      
      <!-- Redirects to configurations page -->
      <Action name="viewConfigurations"/>
    </Action>
    

    <!--
			*
			*    deleteCompany  |  Deletes a company.
			*
		-->
    <Action name="deleteCompany">
      <!-- Deletes the company -->
      <Call library="framework,company,api" function="delete">
        <Param name="id"><ActionValue/></Param>
      </Call>
      
      <!-- Redirects to main page -->
      <Action name="init"/>
    </Action>
    
    
    <!--
			*
			*    deleteConfig [configurationsScreen]  |  Deletes a company's configuration.
			*
		-->
    <Action name="deleteConfig">
      <!-- Deletes the config -->
      <Call library="framework,config,api" function="delete">
        <Param name="id"><ActionValue/></Param>
      </Call>
      
      <!-- Redirects to configurations page -->
      <Action name="viewConfigurations"/>
    </Action>
    
		
		<!--
			*
			*    editConfig [configurationsScreen]  |  Configuration of 'detailsScreen', to edit a company's configuration.
			*
		-->
		<Action name="editConfig" screen="detailsScreen">
      <Var name="config">
        <Call library="framework,config,api" function="getById">
          <Param name="id"><ActionValue/></Param>
        </Call>
      </Var>
			<Control method="bind" object="detailsForm">
				<Param><Var name="config"/></Param>
			</Control>
		</Action>
    
  
    <!--
      *
      *    saveCompanies  |  Saves a company's details or creates a new one.
      *
    -->
    <Action name="saveCompanies">
      <!-- Saves companies' details, accordingly:
        . Creates a new company;
        OR
        . Updates the selected ones;
      -->
      <ForEach var="POSTDATA" item="item" key="key">
        <Var name="key" dump="true"/>
        <Var name="item" dump="true"/>
        <!-- New company row identified by empty key. If name and code not empty, needs to be added -->
        <If condition="($key=='' &amp;&amp; $key!='0') &amp;&amp; ($item->name != '' &amp;&amp; $item->code != '')">
          <Then>
            <Call library="framework,company,api" function="add">
              <Param name="name"><Var name="item" key="name"/></Param>
              <Param name="code"><Var name="item" key="code"/></Param>
              <Param name="description"><Var name="item" key="description"/></Param>
              <Param name="id_timezone"><Var name="item" key="id_timezone"/></Param>
              <Param name="is_active"><Var name="item" key="is_active"/></Param>
              <Param name="id_company"><Var name="item" key="id_company"/></Param>
            </Call>
          </Then>
          <Else>
            <!-- Every other row, if changed, it's a company update -->
            <If condition="$item->CHANGED">
              <Then>
                <Call library="framework,company,api" function="update">
                  <Param name="id"><String.parse><Var name="key"/></String.parse></Param>
                  <Param name="name"><Var name="item" key="name"/></Param>
                  <Param name="code"><Var name="item" key="code"/></Param>
                  <Param name="description"><Var name="item" key="description"/></Param>
                  <Param name="id_timezone"><Var name="item" key="id_timezone"/></Param>
                  <Param name="is_active"><Var name="item" key="is_active"/></Param>
                  <Param name="id_company"><Var name="item" key="id_company"/></Param>
                </Call>
              </Then>
            </If>
          </Else>
        </If>
      </ForEach>
      
      <!-- Redirects to the main page -->
      <Action name="init"/>
    </Action>
    
    
    <!--
			*
    	*   saveAllConfigs [configurationsScreen]  |  Saves all the configurations of a company or creates a new one.
			*
		-->
    <Action name="saveAllConfigs">
      <!-- Saves the company's configurations, accordingly:
        . Creates a new config;
        OR
        . Updates the selected ones;
      -->
      <ForEach var="POSTDATA" item="item" key="key">
        <!-- New config row identified by empty key. If name and code not empty, needs to be added -->
        <If condition="($key=='' &amp;&amp; $key!='0') &amp;&amp; ($item->code != '' &amp;&amp; $item->value != '')">
          <Then>
            <Call library="framework,config,api" function="add">
              <Param name="id_company"><Var name="selectedCompanyId" process="true"/></Param>
              <Param name="code"><Var name="item" key="code"/></Param>
              <Param name="value"><Var name="item" key="value"/></Param>
              <Param name="comment"><Var name="item" key="comment"/></Param>
            </Call>
          </Then>
          <Else>
            <!-- Every other row, if changed, it's a config update -->
            <If condition="$item->CHANGED">
              <Then>
                <Call library="framework,config,api" function="update">
                  <Param name="id"><String.parse><Var name="key"/></String.parse></Param>
                  <Param name="code"><Var name="item" key="code"/></Param>
                  <Param name="value"><Var name="item" key="value"/></Param>
                  <Param name="comment"><Var name="item" key="comment"/></Param>
                </Call>
              </Then>
            </If>
          </Else>
        </If>
      </ForEach>
      
      <!-- Redirects to configs' page  -->
      <Action name="viewConfigurations"/>
    </Action>
    
		
		<!--
			*
			*    saveConfig [detailsScreen]  |  Saves the details of a company's configuration.
			*
		-->
		<Action name="saveConfig">
      <!-- Updates the configuration -->
      <Call library="framework,config,api" function="update" params="POSTDATA">
        <Param name="id"><Var name="POSTDATA" key="id"/></Param>
      </Call>
			
			<!-- Returns to configurations page -->
			<Action name="viewConfigurations"/>
		</Action>
    
    
    <!--
			*
			*    viewConfigurations  |  Configuration of 'configurationsScreen', to edit a company's configurations.
			*
		-->
    <Action name="viewConfigurations" screen="configurationsScreen">
      <!-- Gets all the company configurations and a blank row at the end, to add a new one, if wanted -->
      <Var name="configs">
        <Call library="framework,config,api" function="getByCompany">
          <Param name="id_company"><Var name="selectedCompanyId" process="true"/></Param>
        </Call>
      </Var>
      <Var name="configs" key=""><Null/></Var>
      <Control method="bind" object="configsGrid">
        <Param><Var name="configs"/></Param>
      </Control>
    </Action>


    <!--
			*
			*    back  |  Returns to the backoffice [gecol.dashboard] main page.
			*
		-->
    <Action name="back">
      <!-- Switches to 'backoffice' node -->
      <RaiseEvent name="back"/>
    </Action>
  </Actions>
</Node>
